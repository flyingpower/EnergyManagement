# Energy Management System - Scripts
# Charging control scripts with DUAL control methods (Tesla & Easee)
# UPDATED with verified entity IDs and both control methods

script:
  # ============================================================================
  # PV SURPLUS CHARGING SCRIPTS
  # ============================================================================

  adjust_pv_charging:
    alias: "PV-Ladung anpassen"
    description: "Passt den Ladestrom basierend auf verf√ºgbarem PV-√úberschuss an (Easee) mit Hysterese"
    sequence:
      - variables:
          surplus: "{{ states('sensor.verfugbarer_pv_uberschuss') | float(0) }}"
          min_surplus: "{{ states('input_number.min_pv_surplus') | float(1400) }}"
          buffer: "{{ states('input_number.pv_charging_buffer') | float(200) }}"
          stop_threshold: "{{ (min_surplus - buffer) | int }}"
          calculated_current: "{{ states('sensor.berechneter_ladestrom_pv') | int(0) }}"
          is_charging: "{{ is_state('sensor.garage_status', 'charging') }}"

      # Log current state for debugging
      - service: system_log.write
        data:
          message: >
            PV Charging check: surplus={{ surplus }}W, start_threshold={{ min_surplus }}W,
            stop_threshold={{ stop_threshold }}W, current={{ calculated_current }}A, is_charging={{ is_charging }}
          level: debug

      - choose:
          # ========== CASE 1: Start Charging (with high threshold) ==========
          - conditions:
              - condition: template
                value_template: "{{ surplus >= min_surplus }}"
              - condition: template
                value_template: "{{ not is_charging }}"
              - condition: template
                value_template: "{{ calculated_current >= 6 }}"
            sequence:
              - service: system_log.write
                data:
                  message: "PV Charging: Starting with {{ calculated_current }}A (surplus: {{ surplus }}W)"
                  level: info

              # Force 1-phase mode for PV charging
              - service: easee.set_charger_phase_mode
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  phase_mode: "1_phase"
              - delay:
                  seconds: 2
              - service: easee.set_charger_dynamic_limit
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  current: "{{ calculated_current }}"
                  time_to_live: 0
              - delay:
                  seconds: 2
              - service: easee.action_command
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  action_command: "start"

              # Send notification
              - service: notify.notify
                data:
                  title: "‚òÄÔ∏è PV-Laden gestartet"
                  message: >
                    √úberschuss: {{ surplus }} W
                    Ladestrom: {{ calculated_current }} A (1-Phase)

          # ========== CASE 2: Adjust Current (Already Charging, use lower threshold) ==========
          - conditions:
              - condition: template
                value_template: "{{ surplus >= stop_threshold }}"
              - condition: template
                value_template: "{{ is_charging }}"
              - condition: template
                value_template: "{{ calculated_current >= 6 }}"
            sequence:
              - service: system_log.write
                data:
                  message: "PV Charging: Adjusting to {{ calculated_current }}A (surplus: {{ surplus }}W)"
                  level: debug

              # Adjust charging current (1-phase mode already set)
              - service: easee.set_charger_dynamic_limit
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  current: "{{ calculated_current }}"
                  time_to_live: 0

          # ========== CASE 3: Stop Charging (Below stop threshold OR current too low) ==========
          - conditions:
              - condition: template
                value_template: "{{ (surplus < stop_threshold) or (calculated_current < 6) }}"
              - condition: template
                value_template: "{{ is_charging }}"
            sequence:
              - service: system_log.write
                data:
                  message: "PV Charging: Stopping (surplus: {{ surplus }}W < stop_threshold: {{ stop_threshold }}W)"
                  level: info

              - service: script.stop_charging

              # Send notification
              - service: notify.notify
                data:
                  title: "‚è∏Ô∏è PV-Laden gestoppt"
                  message: >
                    √úberschuss zu gering: {{ surplus }} W
                    (Stopp-Schwelle: {{ stop_threshold }} W)

  adjust_pv_charging_smart:
    alias: "PV-Ladung anpassen (Smart mit Zeitstabilit√§t)"
    description: "Passt den Ladestrom mit Zeitstabilit√§t und dynamischer Anpassung an"
    sequence:
      - variables:
          surplus: "{{ states('sensor.verfugbarer_pv_uberschuss') | float(0) }}"
          min_surplus: "{{ states('input_number.min_pv_surplus') | float(1400) }}"
          buffer: "{{ states('input_number.pv_charging_buffer') | float(200) }}"
          target_current: "{{ states('sensor.pv_target_charging_current') | int(0) }}"
          net_consumption: "{{ states('sensor.net_grid_consumption') | float(0) }}"
          is_charging: "{{ is_state('sensor.garage_status', 'charging') }}"
          current_charging_amps: "{{ states('sensor.garage_dynamic_charger_limit') | int(0) }}"
          start_timer: "{{ states('input_number.pv_start_condition_timer') | int(0) }}"
          stop_timer: "{{ states('input_number.pv_stop_condition_timer') | int(0) }}"

      # ========== Update Start Timer ==========
      - choose:
          # Start condition met: surplus >= min_pv_surplus
          - conditions:
              - condition: template
                value_template: "{{ surplus >= min_surplus }}"
              - condition: template
                value_template: "{{ not is_charging }}"
            sequence:
              # Increment start timer (by 30 seconds)
              - service: input_number.set_value
                target:
                  entity_id: input_number.pv_start_condition_timer
                data:
                  value: "{{ [start_timer + 30, 600] | min }}"
              # Reset stop timer
              - service: input_number.set_value
                target:
                  entity_id: input_number.pv_stop_condition_timer
                data:
                  value: 0
        default:
          # Start condition NOT met - reset start timer
          - service: input_number.set_value
            target:
              entity_id: input_number.pv_start_condition_timer
            data:
              value: 0

      # ========== Update Stop Timer ==========
      - choose:
          # Stop condition met: at 5A minimum AND consuming from grid
          - conditions:
              - condition: template
                value_template: "{{ is_charging }}"
              - condition: template
                value_template: "{{ current_charging_amps <= 6 }}"
              - condition: template
                value_template: "{{ net_consumption > buffer }}"
            sequence:
              # Increment stop timer (by 30 seconds)
              - service: input_number.set_value
                target:
                  entity_id: input_number.pv_stop_condition_timer
                data:
                  value: "{{ [stop_timer + 30, 600] | min }}"
              # Reset start timer
              - service: input_number.set_value
                target:
                  entity_id: input_number.pv_start_condition_timer
                data:
                  value: 0
        default:
          # Stop condition NOT met - reset stop timer
          - service: input_number.set_value
            target:
              entity_id: input_number.pv_stop_condition_timer
            data:
              value: 0

      # Log current state for debugging
      - service: system_log.write
        data:
          message: >
            PV Smart: surplus={{ surplus }}W, target_current={{ target_current }}A,
            net={{ net_consumption }}W, is_charging={{ is_charging }},
            start_timer={{ start_timer }}s, stop_timer={{ stop_timer }}s
          level: debug

      # ========== Execute Charging Logic ==========
      - choose:
          # CASE 1: Start Charging (timer >= 180 seconds = 3 minutes)
          - conditions:
              - condition: template
                value_template: "{{ start_timer >= 180 }}"
              - condition: template
                value_template: "{{ not is_charging }}"
              - condition: template
                value_template: "{{ target_current >= 6 }}"
            sequence:
              - service: system_log.write
                data:
                  message: "PV Smart: Starting with {{ target_current }}A (surplus stable for {{ start_timer }}s)"
                  level: info

              # Force 1-phase mode for PV charging
              - service: easee.set_charger_phase_mode
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  phase_mode: "1_phase"
              - delay:
                  seconds: 2
              - service: easee.set_charger_dynamic_limit
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  current: "{{ target_current }}"
                  time_to_live: 0
              - delay:
                  seconds: 2
              - service: easee.action_command
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  action_command: "start"

              # Reset start timer after starting
              - service: input_number.set_value
                target:
                  entity_id: input_number.pv_start_condition_timer
                data:
                  value: 0

              # Send notification
              - service: notify.notify
                data:
                  title: "‚òÄÔ∏è PV-Laden gestartet"
                  message: >
                    √úberschuss: {{ surplus }} W (stabil f√ºr 3+ Minuten)
                    Ladestrom: {{ target_current }} A (1-Phase)
                    Netz: {{ net_consumption }} W

          # CASE 2: Adjust Current (Already Charging)
          - conditions:
              - condition: template
                value_template: "{{ is_charging }}"
              - condition: template
                value_template: "{{ stop_timer < 180 }}"
              - condition: template
                value_template: "{{ target_current >= 6 }}"
              - condition: template
                value_template: "{{ target_current != current_charging_amps }}"
            sequence:
              - service: system_log.write
                data:
                  message: "PV Smart: Adjusting from {{ current_charging_amps }}A to {{ target_current }}A (net: {{ net_consumption }}W)"
                  level: debug

              # Dynamically adjust charging current to maintain ~0W net
              - service: easee.set_charger_dynamic_limit
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  current: "{{ target_current }}"
                  time_to_live: 0

          # CASE 3: Stop Charging (timer >= 180 seconds at minimum current)
          - conditions:
              - condition: template
                value_template: "{{ stop_timer >= 180 }}"
              - condition: template
                value_template: "{{ is_charging }}"
            sequence:
              - service: system_log.write
                data:
                  message: "PV Smart: Stopping (at minimum 6A, consuming {{ net_consumption }}W from grid for {{ stop_timer }}s)"
                  level: info

              - service: script.stop_charging

              # Reset stop timer after stopping
              - service: input_number.set_value
                target:
                  entity_id: input_number.pv_stop_condition_timer
                data:
                  value: 0

              # Send notification
              - service: notify.notify
                data:
                  title: "‚è∏Ô∏è PV-Laden gestoppt"
                  message: >
                    √úberschuss nicht ausreichend (3+ Minuten)
                    Ladestrom war bei Minimum (6A)
                    Netz-Verbrauch: {{ net_consumption }} W

  # ============================================================================
  # PRICE-BASED CHARGING SCRIPTS
  # ============================================================================

  calculate_optimal_charging_hours:
    alias: "Optimale Ladezeiten berechnen"
    description: "Berechnet die g√ºnstigsten Stunden zum Laden basierend auf Tibber-Preisen"
    sequence:
      # Retrieve Tibber prices for today and tomorrow
      - service: tibber.get_prices
        data:
          start: "{{ today_at('00:00:00') }}"
          end: "{{ (now() + timedelta(days=1)).replace(hour=23, minute=59, second=59) }}"
        response_variable: tibber_prices

      # Fire event with price data to trigger sensor update
      - event: tibber_prices_updated
        event_data:
          prices: "{{ tibber_prices.prices }}"

      # Log confirmation
      - service: system_log.write
        data:
          message: "Tibber prices updated via event"
          level: info

  start_price_charging:
    alias: "Preisbasierte Ladung starten"
    description: "Startet Ladung w√§hrend g√ºnstiger Preisstunden (Easee)"
    sequence:
      - variables:
          current_price: "{{ states('sensor.aktueller_strompreis') | float(0) }}"
          threshold_50: "{{ states('input_number.price_threshold_50') | float(0.30) }}"
          threshold_80: "{{ states('input_number.price_threshold_80') | float(0.28) }}"
          current_soc: "{{ states('sensor.tesla_ladestand') | float(0) }}"
          is_charging: "{{ is_state('sensor.garage_status', 'charging') }}"

      - choose:
          # Very cheap - charge to 80%
          - conditions:
              - condition: template
                value_template: "{{ current_price <= threshold_80 }}"
              - condition: template
                value_template: "{{ current_soc < 80 }}"
            sequence:
              # Only set current when starting charging (not if already charging)
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ not is_charging }}"
                    sequence:
                      # Force 3-phase mode for grid charging
                      - service: easee.set_charger_phase_mode
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          phase_mode: "3_phase"
                      - delay:
                          seconds: 1
                      - service: easee.set_charger_dynamic_limit
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          current: 32
                          time_to_live: 0
                      - delay:
                          seconds: 2
                      - service: easee.action_command
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          action_command: "start"

          # Cheap - charge to 50%
          - conditions:
              - condition: template
                value_template: "{{ current_price <= threshold_50 }}"
              - condition: template
                value_template: "{{ current_soc < 50 }}"
            sequence:
              # Only set current when starting charging (not if already charging)
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ not is_charging }}"
                    sequence:
                      # Force 3-phase mode for grid charging
                      - service: easee.set_charger_phase_mode
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          phase_mode: "3_phase"
                      - delay:
                          seconds: 1
                      - service: easee.set_charger_dynamic_limit
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          current: 32
                          time_to_live: 0
                      - delay:
                          seconds: 2
                      - service: easee.action_command
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          action_command: "start"

  start_emergency_morning_charge:
    alias: "Notladung f√ºr Morgenziel starten"
    description: "Startet Notladung, um das Morgenziel zu erreichen (Easee)"
    sequence:
      - variables:
          target_soc: "{{ states('input_number.target_soc_morning') | int }}"
          is_charging: "{{ is_state('sensor.garage_status', 'charging') }}"

      # Only set current when starting charging (not if already charging)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ not is_charging }}"
            sequence:
              # Force 3-phase mode for fast grid charging
              - service: easee.set_charger_phase_mode
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  phase_mode: "3_phase"
              - delay:
                  seconds: 1
              - service: easee.set_charger_dynamic_limit
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  current: 32
                  time_to_live: 0
              - delay:
                  seconds: 2
              - service: easee.action_command
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  action_command: "start"

  # ============================================================================
  # MANUAL CHARGING SCRIPTS
  # ============================================================================

  execute_manual_charging:
    alias: "Manuelle Ladung ausf√ºhren"
    description: "F√ºhrt manuelle Ladung mit intelligenter Planung aus (Easee)"
    sequence:
      - variables:
          current_soc: "{{ states('sensor.tesla_ladestand') | float(0) }}"
          target_soc: "{{ states('input_number.manual_target_soc') | float(80) }}"
          deadline: "{{ states('input_datetime.manual_deadline') }}"
          pv_surplus: "{{ states('sensor.verfugbarer_pv_uberschuss') | float(0) }}"
          current_price: "{{ states('sensor.aktueller_strompreis') | float(0) }}"
          min_pv: "{{ states('input_number.min_pv_surplus') | float(1400) }}"
          is_charging: "{{ is_state('sensor.garage_status', 'charging') }}"

      - choose:
          # Already at target
          - conditions:
              - condition: template
                value_template: "{{ current_soc >= target_soc }}"
            sequence:
              - service: script.stop_charging

          # Use PV if available
          - conditions:
              - condition: template
                value_template: "{{ pv_surplus >= min_pv }}"
            sequence:
              - service: script.adjust_pv_charging

          # Use grid charging
          - conditions:
              - condition: template
                value_template: "{{ current_soc < target_soc }}"
            sequence:
              # Only set current when starting charging (not if already charging)
              - choose:
                  - conditions:
                      - condition: template
                        value_template: "{{ not is_charging }}"
                    sequence:
                      # Force 3-phase mode for grid charging (manual mode without PV)
                      - service: easee.set_charger_phase_mode
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          phase_mode: "3_phase"
                      - delay:
                          seconds: 1
                      - service: easee.set_charger_dynamic_limit
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          current: 32
                          time_to_live: 0
                      - delay:
                          seconds: 2
                      - service: easee.action_command
                        data:
                          device_id: 4997305f9b10ff58595e095f3bdf74cd
                          action_command: "start"

  # ============================================================================
  # EMERGENCY CHARGING SCRIPTS
  # ============================================================================

  start_emergency_charging:
    alias: "Notladung starten"
    description: "Startet Notladung bei kritischem Ladestand (Easee)"
    sequence:
      - variables:
          is_charging: "{{ is_state('sensor.garage_status', 'charging') }}"

      # Only set current when starting charging (not if already charging)
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ not is_charging }}"
            sequence:
              # Force 3-phase mode for fast emergency charging
              - service: easee.set_charger_phase_mode
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  phase_mode: "3_phase"
              - delay:
                  seconds: 1
              - service: easee.set_charger_dynamic_limit
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  current: 32
                  time_to_live: 0
              - delay:
                  seconds: 2
              - service: easee.action_command
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  action_command: "start"

      - service: notify.mobile_app
        data:
          title: "üö® Notladung aktiviert"
          message: >
            Kritischer Ladestand: {{ states('sensor.tesla_ladestand') }}%
            Maximale Ladeleistung aktiviert.
          data:
            priority: high

  # ============================================================================
  # UTILITY SCRIPTS
  # ============================================================================

  stop_charging:
    alias: "Ladung stoppen"
    description: "Stoppt die Ladung (nur Easee)"
    sequence:
      # Always use Easee to stop charging
      - service: easee.action_command
        data:
          device_id: 4997305f9b10ff58595e095f3bdf74cd
          action_command: "pause"
      - delay:
          milliseconds: 500
      # Send pause again to ensure it worked
      - service: easee.action_command
        data:
          device_id: 4997305f9b10ff58595e095f3bdf74cd
          action_command: "pause"

      - delay:
          seconds: 2
      - condition: template
        value_template: "{{ not is_state('input_select.charging_state', 'manual') }}"
      - service: input_select.select_option
        target:
          entity_id: input_select.charging_state
        data:
          option: "idle"

  # ============================================================================
  # DIAGNOSTIC SCRIPT
  # ============================================================================

  test_tibber_forecast:
    alias: "Test: Tibber Forecast Laden"
    description: "Manuell Tibber Preisprognose aktualisieren"
    sequence:
      - service: input_boolean.turn_on
        target:
          entity_id: input_boolean.trigger_price_update
      - delay:
          seconds: 3
      - service: input_boolean.turn_off
        target:
          entity_id: input_boolean.trigger_price_update
      - delay:
          seconds: 5
      - service: persistent_notification.create
        data:
          title: "Tibber Forecast Status"
          message: |
            **Sensor:** {{ states('sensor.tibber_preisprognose') }}
            **Prices:** {{ state_attr('sensor.tibber_preisprognose', 'prices_today') | length if state_attr('sensor.tibber_preisprognose', 'prices_today') else 'NO DATA' }} Eintr√§ge
            **Last Update:** {{ state_attr('sensor.tibber_preisprognose', 'last_update') }}

  test_store_prices_manually:
    alias: "Test: Store Prices Manually"
    sequence:
      - service: tibber.get_prices
        response_variable: resp
      - service: input_text.set_value
        target:
          entity_id: input_text.optimal_charging_schedule
        data:
          value: "{{ resp | tojson }}"
      - delay:
          seconds: 2
      - service: persistent_notification.create
        data:
          title: "Manual Store Test"
          message: |
            Stored {{ states('input_text.optimal_charging_schedule') | length }} chars
            
            First 150: {{ states('input_text.optimal_charging_schedule')[:150] }}
