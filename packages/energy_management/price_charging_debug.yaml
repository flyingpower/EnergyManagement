# Debug sensor for price-based charging
# Shows why charging is or isn't starting

template:
  - sensor:
      - name: "Debug Preisladen"
        unique_id: debug_price_charging
        state: >
          {% if state_attr('sensor.optimaler_ladeplan', 'should_charge_now') == true %}
            Sollte laden
          {% else %}
            Sollte nicht laden
          {% endif %}
        attributes:
          # Current conditions
          current_price: "{{ states('sensor.aktueller_strompreis') | float(0) }}"
          current_soc: "{{ states('sensor.tesla_ladestand') | float(0) }}"
          threshold_80: "{{ states('input_number.price_threshold_80') | float(0) }}"
          threshold_50: "{{ states('input_number.price_threshold_50') | float(0) }}"
          current_hour: "{{ now().hour }}"

          # Sensor calculation
          should_charge_now: "{{ state_attr('sensor.optimaler_ladeplan', 'should_charge_now') }}"

          # Automation conditions
          enable_price_charging: "{{ states('input_boolean.enable_price_charging') }}"
          auto_angeschlossen: "{{ states('binary_sensor.auto_angeschlossen') }}"
          manual_charging_mode: "{{ states('input_boolean.manual_charging_mode') }}"
          notladung_erforderlich: "{{ states('binary_sensor.notladung_erforderlich') }}"

          # Charging state
          garage_status: "{{ states('sensor.garage_status') }}"
          charging_state: "{{ states('input_select.charging_state') }}"

          # Conditions met?
          all_conditions_met: >
            {% set c1 = is_state('input_boolean.enable_price_charging', 'on') %}
            {% set c2 = is_state('binary_sensor.auto_angeschlossen', 'on') %}
            {% set c3 = is_state('input_boolean.manual_charging_mode', 'off') %}
            {% set c4 = is_state('binary_sensor.notladung_erforderlich', 'off') %}
            {% if c1 and c2 and c3 and c4 %}
              Ja
            {% else %}
              Nein - {% if not c1 %}Preisladen aus{% endif %}{% if not c2 %} Auto nicht angeschlossen{% endif %}{% if not c3 %} Manueller Modus aktiv{% endif %}{% if not c4 %} Notladung aktiv{% endif %}
            {% endif %}

          # What should happen?
          expected_action: >
            {% set should_charge = state_attr('sensor.optimaler_ladeplan', 'should_charge_now') %}
            {% set is_charging = is_state('sensor.garage_status', 'charging') %}
            {% set all_ok = is_state('input_boolean.enable_price_charging', 'on') and is_state('binary_sensor.auto_angeschlossen', 'on') and is_state('input_boolean.manual_charging_mode', 'off') and is_state('binary_sensor.notladung_erforderlich', 'off') %}
            {% if not all_ok %}
              Bedingungen nicht erfüllt
            {% elif should_charge == true and not is_charging %}
              Laden starten
            {% elif should_charge == false and is_charging %}
              Laden stoppen
            {% else %}
              Keine Aktion nötig
            {% endif %}

          # Charging plan for current hour
          current_hour_plan: >
            {% set plan = state_attr('sensor.optimaler_ladeplan', 'charging_plan') %}
            {% set now_hour = now().hour %}
            {% if plan and plan is iterable %}
              {% for hour in plan %}
                {% if hour.hour == now_hour %}
                  Preis: {{ hour.price }}€, Sollte laden: {{ hour.should_charge }}, Grund: {{ hour.charge_reason }}, SoC Ende: {{ hour.soc_end }}%
                {% endif %}
              {% endfor %}
            {% else %}
              Kein Plan verfügbar
            {% endif %}
