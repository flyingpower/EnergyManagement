# Price-Based Charging Execution
# Automatically starts/stops charging based on optimal plan

automation:
  # Execute optimal charging plan every hour
  - id: energy_mgmt_execute_price_plan
    alias: "Energie Management - Preisplan ausf√ºhren"
    description: "Startet/stoppt Ladung basierend auf optimalem Preisplan"
    trigger:
      # Check at the start of every hour
      - platform: time_pattern
        minutes: "0"
      # Also check every 5 minutes (to catch mid-hour starts)
      - platform: time_pattern
        minutes: "/5"
      # Also check when plan updates
      - platform: state
        entity_id: sensor.optimaler_ladeplan
    condition:
      # Only execute if price-based charging is enabled
      - condition: state
        entity_id: input_boolean.enable_price_charging
        state: "on"
      # Car must be connected
      - condition: state
        entity_id: binary_sensor.auto_angeschlossen
        state: "on"
      # Not in manual mode
      - condition: state
        entity_id: input_boolean.manual_charging_mode
        state: "off"
      # Not in emergency mode
      - condition: state
        entity_id: binary_sensor.notladung_erforderlich
        state: "off"
    mode: restart
    action:
      - variables:
          should_charge: "{{ state_attr('sensor.optimaler_ladeplan', 'should_charge_now') | default(false) }}"
          is_charging: "{{ is_state('sensor.garage_status', 'charging') }}"
          current_soc: "{{ states('sensor.tesla_ladestand') | float(0) }}"

      # Log decision info
      - service: system_log.write
        data:
          message: >
            Price charging automation triggered:
            should_charge={{ should_charge }},
            is_charging={{ is_charging }},
            soc={{ current_soc }}%,
            hour={{ now().hour }}
          level: info

      - choose:
          # Should charge and not charging -> Start
          - conditions:
              - condition: template
                value_template: "{{ should_charge == true or should_charge == 'True' }}"
              - condition: template
                value_template: "{{ not is_charging }}"
            sequence:
              - service: input_select.select_option
                target:
                  entity_id: input_select.charging_state
                data:
                  option: "price"
              # Force 3-phase mode for grid charging
              - service: easee.set_charger_phase_mode
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  phase_mode: "3_phase"
              - delay:
                  seconds: 1
              # Set charging current to 16A (3-phase)
              - service: easee.set_charger_dynamic_limit
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  current: 16
                  time_to_live: 0
              - delay:
                  seconds: 2
              - service: easee.action_command
                data:
                  device_id: 4997305f9b10ff58595e095f3bdf74cd
                  action_command: "start"
              - service: system_log.write
                data:
                  message: "Price charging started: SoC={{ current_soc }}%"
                  level: info
              - service: notify.notify
                data:
                  title: "üîå Ladung gestartet"
                  message: >
                    {% set plan = state_attr('sensor.optimaler_ladeplan', 'charging_plan') %}
                    {% set now_hour = now().hour %}
                    {% set charge_reason = 'Unbekannt' %}
                    {% set current_price = states('sensor.aktueller_strompreis') | float(0) %}
                    {% if plan is not none and plan is iterable %}
                      {% for hour in plan %}
                        {% if hour.hour == now_hour %}
                          {% if hour.charge_reason == 'price_80' %}
                            {% set charge_reason = 'Sehr g√ºnstiger Preis (‚â§' ~ states('input_number.price_threshold_80') ~ '‚Ç¨)' %}
                          {% elif hour.charge_reason == 'price_50' %}
                            {% set charge_reason = 'G√ºnstiger Preis (‚â§' ~ states('input_number.price_threshold_50') ~ '‚Ç¨)' %}
                          {% elif hour.charge_reason == 'morning_target' %}
                            {% set charge_reason = 'Morgenziel erreichen (7:00 Uhr)' %}
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                    Ladestand: {{ current_soc }}%
                    Grund: {{ charge_reason }}
                    Aktueller Preis: {{ current_price | round(3) }} ‚Ç¨/kWh

          # Should not charge and is charging -> Stop
          - conditions:
              - condition: template
                value_template: "{{ should_charge == false or should_charge == 'False' }}"
              - condition: template
                value_template: "{{ is_charging }}"
              - condition: state
                entity_id: input_select.charging_state
                state: "price"
            sequence:
              - service: script.stop_charging
              - service: system_log.write
                data:
                  message: "Price charging stopped: SoC={{ current_soc }}%"
                  level: info
              - service: notify.notify
                data:
                  title: "‚è∏Ô∏è Ladung gestoppt"
                  message: >
                    Ladestand: {{ current_soc }}%
                    Ziel bis 7:00: {{ states('input_number.target_soc_morning') }}%
                    N√§chste Ladung: {{ state_attr('sensor.optimaler_ladeplan', 'next_charging_hour') | default('Nicht geplant') }}

        # Default: Log when no action taken
        default:
          - service: system_log.write
            data:
              message: >
                Price charging: No action needed.
                should_charge={{ should_charge }},
                is_charging={{ is_charging }},
                charging_state={{ states('input_select.charging_state') }}
              level: debug

  # Update plan every hour
  - id: energy_mgmt_update_price_plan
    alias: "Energie Management - Preisplan aktualisieren"
    description: "Aktualisiert den optimalen Ladeplan st√ºndlich"
    trigger:
      - platform: time_pattern
        minutes: "5"  # Run 5 minutes after the hour
      - platform: state
        entity_id: sensor.tibber_preisprognose
    action:
      - service: homeassistant.update_entity
        target:
          entity_id: sensor.optimaler_ladeplan
