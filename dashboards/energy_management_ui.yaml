views:
  - title: Energie Management
    path: energie-management
    icon: mdi:car-electric
    badges: []
    cards:
      # ============================================================================
      # STATUS OVERVIEW
      # ============================================================================

      - type: vertical-stack
        title: Status √úbersicht
        cards:
          # Current Charging Mode
          - type: entities
            entities:
              - entity: sensor.aktueller_lademodus
                name: Aktueller Modus
                icon: mdi:state-machine
              - entity: input_select.charging_state
                name: Systemstatus
              - entity: binary_sensor.auto_angeschlossen
                name: Auto verbunden

          # Key Metrics
          - type: horizontal-stack
            cards:
              # Tesla SOC Gauge
              - type: gauge
                entity: sensor.tesla_ladestand
                name: Ladestand
                min: 0
                max: 100
                severity:
                  green: 60
                  yellow: 40
                  red: 20

              # Current Price
              - type: gauge
                entity: sensor.aktueller_strompreis
                name: Strompreis
                min: 0
                max: 0.50
                severity:
                  green: 0
                  yellow: 0.30
                  red: 0.40
                unit: EUR/kWh

              # PV Surplus
              - type: gauge
                entity: sensor.verfugbarer_pv_uberschuss
                name: PV-√úberschuss
                min: 0
                max: 3000
                severity:
                  green: 1400
                  yellow: 1000
                  red: 0
                unit: W

          # Charging Power and Status
          - type: entities
            entities:
              - entity: sensor.tesla_ladestatus
                name: Tesla Status
              - entity: sensor.easee_ladegerat_status
                name: Ladeger√§t Status
              - entity: sensor.aktuelle_ladeleistung
                name: Aktuelle Leistung
              - entity: sensor.berechneter_ladestrom_pv
                name: Berechneter Strom (PV)
              - entity: sensor.preisniveau
                name: Aktuelles Preisniveau

      # ============================================================================
      # MANUAL CHARGING CONTROLS
      # ============================================================================

      - type: vertical-stack
        title: Manueller Lademodus
        cards:
          - type: entities
            entities:
              - entity: input_boolean.manual_charging_mode
                name: Manuellen Modus aktivieren

          - type: conditional
            conditions:
              - entity: input_boolean.manual_charging_mode
                state: "on"
            card:
              type: entities
              entities:
                - entity: input_number.manual_target_soc
                  name: Ziel-Ladestand
                - entity: input_datetime.manual_deadline
                  name: Deadline
                - entity: sensor.benotigte_energie_bis_ziel
                  name: Ben√∂tigte Energie
                - entity: sensor.geschatzte_ladedauer
                  name: Gesch√§tzte Dauer

      # ============================================================================
      # SETTINGS
      # ============================================================================

      - type: vertical-stack
        title: Einstellungen
        cards:
          # Enable/Disable Features
          - type: entities
            title: Aktivierte Funktionen
            entities:
              - entity: input_boolean.enable_pv_charging
                name: PV-Laden
              - entity: input_boolean.enable_price_charging
                name: Preisbasiertes Laden
              - entity: input_boolean.enable_morning_readiness
                name: Morgen-Bereitschaft

          # Morning Readiness Settings
          - type: entities
            title: Morgen-Bereitschaft
            entities:
              - entity: input_number.target_soc_morning
                name: Ziel-Ladestand (7:00 Uhr)
              - entity: sensor.benotigte_energie_bis_ziel
                name: Ben√∂tigte Energie
              - entity: binary_sensor.morgenziel_erreichbar
                name: Ziel erreichbar

          # Price Thresholds
          - type: entities
            title: Preisschwellen
            entities:
              - entity: input_number.price_threshold_80
                name: Schwelle f√ºr 80% Ladung
              - entity: input_number.price_threshold_50
                name: Schwelle f√ºr 50% Ladung
              - entity: sensor.aktueller_strompreis
                name: Aktueller Preis

          # PV Charging Settings
          - type: entities
            title: PV-Laden Einstellungen
            entities:
              - entity: input_number.min_pv_surplus
                name: Minimaler √úberschuss
              - entity: input_number.pv_charging_buffer
                name: Sicherheitspuffer
              - entity: input_number.pv_hysteresis_time
                name: Hysterese-Zeit
              - entity: sensor.verfugbarer_pv_uberschuss
                name: Aktueller √úberschuss

      # ============================================================================
      # DETAILED STATUS
      # ============================================================================

      - type: vertical-stack
        title: Detaillierter Status
        cards:
          # Tesla Information
          - type: entities
            title: Tesla
            entities:
              - entity: sensor.tesla_ladestand
                name: Ladestand
              - entity: sensor.tesla_ladestatus
                name: Status
              - entity: sensor.model_3_battery_level
                name: Batterie (Original)
              - entity: sensor.model_3_charging
                name: Ladezustand (Original)

          # Easee Charger Information
          - type: entities
            title: Easee Ladeger√§t
            entities:
              - entity: sensor.easee_ladegerat_status
                name: Status
              - entity: sensor.aktuelle_ladeleistung
                name: Leistung
              - entity: sensor.garage_power
                name: Leistung (Original kW)
              - entity: sensor.garage_status
                name: Status (Original)
              - entity: sensor.garage_session_energy
                name: Geladene Energie (kWh)

          # Tibber Information
          - type: entities
            title: Tibber Energie
            entities:
              - entity: sensor.aktueller_strompreis
                name: Aktueller Preis
              - entity: sensor.preisniveau
                name: Preisniveau
              - entity: sensor.verfugbarer_pv_uberschuss
                name: PV-√úberschuss
              - entity: sensor.tibber_power
                name: Verbrauch (W)
              - entity: sensor.tibber_power_production
                name: Produktion (W)
              - entity: sensor.tibber_electricity_price
                name: Preis (Original)

      # ============================================================================
      # HISTORY & STATISTICS
      # ============================================================================

      - type: vertical-stack
        title: Verlauf
        cards:
          # SOC History
          - type: history-graph
            title: Ladestand Verlauf (24h)
            hours_to_show: 24
            entities:
              - entity: sensor.tesla_ladestand

          # Charging Power History
          - type: history-graph
            title: Ladeleistung Verlauf (24h)
            hours_to_show: 24
            entities:
              - entity: sensor.aktuelle_ladeleistung

          # Price History
          - type: history-graph
            title: Strompreis Verlauf (24h)
            hours_to_show: 24
            entities:
              - entity: sensor.aktueller_strompreis

          # PV Surplus History
          - type: history-graph
            title: PV-√úberschuss Verlauf (24h)
            hours_to_show: 24
            entities:
              - entity: sensor.verfugbarer_pv_uberschuss

          # Charging Mode History
          - type: history-graph
            title: Lademodus Verlauf (24h)
            hours_to_show: 24
            entities:
              - entity: input_select.charging_state

      # ============================================================================
      # CHARGING PLAN FORECAST
      # ============================================================================

      - type: vertical-stack
        title: Ladeplan & Preisprognose
        cards:
          # Next Charging Window
          - type: markdown
            title: N√§chstes Ladefenster
            content: >
              {% set next_hour = state_attr('sensor.optimaler_ladeplan', 'next_charging_hour') %}
              {% set hours_needed = state_attr('sensor.optimaler_ladeplan', 'hours_needed') %}
              {% set should_charge = state_attr('sensor.optimaler_ladeplan', 'should_charge_now') %}

              **Status:** {% if should_charge == true or should_charge == 'True' %}üü¢ L√§dt jetzt{% else %}‚ö™ Wartet{% endif %}

              **N√§chste Ladung:** {{ next_hour if next_hour else 'Nicht geplant' }}

              **Ben√∂tigte Stunden:** {{ hours_needed if hours_needed else 0 }} h bis Morgenziel

              **Sonnenstunden heute:** {{ states('sensor.sonnenstunden_prognose') }} h

              **PV-Prognose (6h):** {{ states('sensor.pv_prognose_nachste_stunden') }} kWh

          # Optimal Charging Plan Timetable
          - type: markdown
            title: Optimaler Ladeplan (bis Prognoseende)
            content: >
              {% set plan = state_attr('sensor.optimaler_ladeplan', 'charging_plan') %}
              {% set solar_forecast = state_attr('sensor.solar_prognose_stundlich', 'hourly_forecast') %}
              {% if plan is none or plan | length == 0 %}
                **Keine Daten verf√ºgbar**

                Bitte "Preisprognose aktualisieren" ausf√ºhren um Tibber-Preise zu laden.
              {% else %}
                {% set now_time = now() %}
                {% set target_time = states('input_number.target_soc_morning') | float(80) %}

                | Zeit | Preis | Laden | SoC | PV | Grund |
                |------|-------|-------|-----|-----|-------|
                {% for hour in plan %}
                  {% set hour_time = hour.datetime | as_datetime %}
                  {% if hour_time >= now_time %}
                    {# Find matching solar forecast #}
                    {% set pv_production = namespace(value=0) %}
                    {% if solar_forecast is not none and solar_forecast is iterable %}
                      {% for solar in solar_forecast %}
                        {% if solar.hour == hour.hour %}
                          {% set pv_production.value = solar.kw %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}

                    {# Charging indicator #}
                    {% set charge_icon = 'üü¢' if hour.should_charge else '‚ö™' %}

                    {# Charge reason display #}
                    {% set reason = 'Sehr g√ºnstig' if hour.charge_reason == 'price_80' else 'G√ºnstig' if hour.charge_reason == 'price_50' else 'Morgenziel' if hour.charge_reason == 'morning_target' else '-' %}

                    | {{ hour.time }} | {{ hour.price | round(3) }} ‚Ç¨ | {{ charge_icon }} | {{ hour.soc_end }}% | {{ pv_production.value | round(1) }} kW | {{ reason }} |
                  {% endif %}
                {% endfor %}

                **Legende:**
                - üü¢ = Ladung geplant
                - ‚ö™ = Keine Ladung
                - SoC = Erwarteter Ladestand am Ende der Stunde
                - PV = Solarprognose f√ºr diese Stunde
                - Grund: Sehr g√ºnstig (‚â§{{ states('input_number.price_threshold_80') }}‚Ç¨), G√ºnstig (‚â§{{ states('input_number.price_threshold_50') }}‚Ç¨), Morgenziel ({{ target_time }}% bis 7:00)
              {% endif %}

          # Current Forecast Status
          - type: entities
            title: Prognose-Status
            entities:
              - entity: sensor.tesla_ladestand
                name: Aktueller Ladestand
              - entity: sensor.aktueller_strompreis
                name: Aktueller Preis
              - entity: input_number.price_threshold_80
                name: Preisschwelle
              - entity: input_number.target_soc_morning
                name: Ziel-Ladestand
              - entity: sensor.benotigte_energie_bis_ziel
                name: Ben√∂tigte Energie
              - entity: sensor.geschatzte_ladedauer
                name: Gesch√§tzte Ladedauer

      # ============================================================================
      # ALERTS & WARNINGS
      # ============================================================================

      - type: conditional
        conditions:
          - entity: binary_sensor.notladung_erforderlich
            state: "on"
        card:
          type: markdown
          content: |
            ## ‚ö†Ô∏è Notladung erforderlich!

            Der Ladestand ist kritisch niedrig ({{ states('sensor.tesla_ladestand') }}%).
            Das System hat automatisch die Notladung aktiviert.

      - type: conditional
        conditions:
          - entity: binary_sensor.morgenziel_erreichbar
            state: "off"
        card:
          type: markdown
          content: |
            ## ‚ö†Ô∏è Morgenziel gef√§hrdet

            Das Fahrzeug wird morgen um 7:00 Uhr wahrscheinlich nicht
            {{ states('input_number.target_soc_morning') }}% erreichen.

            Aktueller Ladestand: {{ states('sensor.tesla_ladestand') }}%
            Gesch√§tzte Ladedauer: {{ states('sensor.geschatzte_ladedauer') }} Stunden

      # ============================================================================
      # QUICK ACTIONS
      # ============================================================================

      - type: entities
        title: Schnellaktionen
        entities:
          - entity: script.adjust_pv_charging
            name: PV-Ladung jetzt anpassen
            icon: mdi:solar-power
          - entity: script.start_emergency_charging
            name: Notladung starten
            icon: mdi:alert-circle
          - entity: script.stop_charging
            name: Ladung stoppen
            icon: mdi:stop-circle
